

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

     <title>Lab 1</title> 
    <meta name="description" content="Morse Code with Timers">
    <meta name="author" content="Caleb Kemere">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/2018/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/2018/assets/themes/bootstrap/elec327.css" rel="stylesheet">
  
    <!--[if lt IE 9]>
      <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script>
    <![endif]-->

    <link href="/2018/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/2018/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>

        <nav class="navbar navbar-expand-lg navbar-dark bg-primary" role="navigation">
        <div class="container">
        <a class="navbar-brand" href="/2018/">Rice ELEC327 - Digital Systems Laboratory</a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="navbar-collapse collapse" id="navbarSupportedContent">
          <ul class="navbar-nav navbar-dark mr-auto">
            
            
            


  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/bonus">Bonus</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/">Home</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/parts_and_notes">Syllabus</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/syllabus">Syllabus</a></li>
      	
      
    
  




            <li class="nav-item dropdown">
              <a href="#" class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Labs</a>
              <ul class="dropdown-menu bg-primary" aria-labelledby="navbarDropdown"role="menu">
                
                
                


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li class="nav-item active"><a href="/2018/lab1/" class="dropdown-item active nav-link">Lab 1</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab2/">Lab 2</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab3/">Lab 3</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab4/">Lab 4</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab5/">Lab 5</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab6/">Lab 6</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab7/">Lab 7</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab8/">Lab 8</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab9/">Lab 9</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/lab10/">Lab 10</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/midterm_project/">Project 1 - Midterm</a></li>
      	
      
    
  
    
      
      	
      	<li class="nav-item"><a class="dropdown-item nav-link" href="/2018/final_project/">Project 2 - Final</a></li>
      	
      
    
  




              </ul>
            </li>
          </ul>
      </div>
      </div>
    </nav>



    <div class="container under-navbar">
      
<h3 id="lab-1-morse-code-with-timers-on-the-msp430-250-pts">Lab #1: Morse Code with Timers on the MSP430 (250 pts)</h3>

<div class="alert alert-info" role="alert">
  <h4 id="there-are-three-goals-for-this-assignment"><strong>There are three goals for this assignment:</strong></h4>

  <ul>
    <li>To get CCS and/or Energia up and running.</li>
    <li>To become familiar with the <em>User Guide</em> and datasheet (these will answer so many questions for you in the future).</li>
    <li>To learn to program an MSP430G2553 when it is separated from the Launchpad.</li>
  </ul>

</div>

<div class="alert alert-danger" role="alert">
  <h4 id="what-should-be-turned-in"><strong>What should be turned in?</strong></h4>

  <ol>
    <li>Your <strong>commented</strong> morse-code.c file.</li>
    <li>Your answers to the questions (given at the end of this document)</li>
    <li>A youtube link to a demo video of your code running after completing Part 3 of the lab.</li>
  </ol>

</div>

<h4 id="due-date-tuesday-january-16-at-600-pm">Due Date: <strong>Tuesday, January 16 at 6:00 pm</strong></h4>

<h4 id="part-0-installation-optional">Part 0: Installation (optional)</h4>

<p>You are welcome to install TI’s <strong>Code Composer Studio</strong> (CCS) on your own personal computers.
There are beta versions available for both OSX and Linux, but in the past these have not
supported all of the features of the Windows version installed in lab.</p>

<p><a href="http://energia.nu/"><strong>Energia</strong></a> is a clone of the Arduino environment for the MSP430. We will
not use the Java-based approach used by Arduino, but the compiliing and device programming
components are still quite useful. Note that the Instructions for installing Energia can be
found at the project home page: <a href="http://energia.nu/">http://energia.nu/</a>. We will not
officially support Energia users in the class, however, we have found it to be quite usable in
a minimal sense. Specifically, by creating a new tab in a sketch with a “.c” extension, one can
write C-language code that is properly understood and compiled. You can then delete all the
stuff in the original sketch window (though it appears you have to leave the file there for
things to work). If you are going to use Energia, please make sure that you <strong>do not</strong> use the
Arduino-style sketch code but rather C-language or assembly.</p>

<p><a href="http://software-dl.ti.com/msp430/msp430_public_sw/mcu/msp430/MSPGCC/latest/index_FDS.html"><strong>msp430-gcc</strong></a>
is a fork of the gcc compiler which has tools to compile, assemble, disasssemble, etc. MSP430
code. By itself, this can be a useful tool for understanding MSP430 code. With the addition of
the mspdebug package (available under Ubuntu Linux or Homebrew), code can also be uploaded to a
device.</p>

<h4 id="part-1-verify-ccsenergia-and-launchpad-functionality-and-examine-the-skeleton-code">Part 1: Verify CCS/Energia and Launchpad functionality and examine the skeleton code</h4>

<p>Compile the included
<a href="https://github.com/ckemere/ELEC327/blob/master/Labs/Lab1/lab1_skeleton.c">lab1_skeleton.c</a>
file to verify that CCS is setup correctly. (In Energia, you will need to create a new
“sketch”, add a tab with the name lab1.c or somesuch, erase the stuff in the first tab, and
then code away in the second “.c” one.) You should also read through this file: it shows the
minimum amount of code needed to run the MSP430 in an infinite loop. If you ever don’t know
what some variable acronym means, look it up! A useful practice is right clicking the name and
going to “Open Declaration” (instructions for CCS are in red). For instance, in this file,
doing this on <code class="highlighter-rouge">CALBC\_1MHZ</code> brings you to:</p>

<p><code class="highlighter-rouge">SFR\_8BIT(CALCBC1\_1MHZ)/\* BSCTL1 Calibration Data for 1 MHz \*/</code></p>

<p>And inspecting <code class="highlighter-rouge">BSTCTL1</code> shows:</p>

<p><code class="highlighter-rouge">SFR\_8BIT(BCSCTL1)/\* Basic Clock System Control \*/</code></p>

<p>What, then, is the “clock system control” that is being referred to? Two resources you should
use extensively are the <a href="/2018/assets/documents/slau144j_userguide.pdf">MSP430x2xx Family User Guide</a>
and the <a href="/2018/assets/documents/msp430g2553.pdf">MSP430G2553 datasheet</a>, both of which can be found
on the main 327 page (or by googling). The user guide explains how to use various functions or
registers common to most MSP430s, while the data sheet has register values and pin information
specific to the G2553. So, searching for “BCSCTL1” on the user guide takes you to Chapter 5 and
Chapter 24, from which you can figure out that this line will set the frequency of the DCO to a
calibrated 1 MHz.</p>

<p>On the web, you may notice a function called “__delay_cycles”. You will find that
documentation of this function is somehwat lacking on the internet. If you look in the <a href="assets/documents/slau132k.pdf">MSP430
Optimizing Compiler Guide</a>, you will see that it is not a C
function, but rather an “intrinsic”. In hindsight, if it’s role is to delay the processor a
precise number of cycles that can range from 1 to some large number, it could not be a function
(because calling a function takes more than one cycle!). A compiler intrinsic is something like
a macro - it is something that is replaced by appropriate code at compile time. In this case,
__delay_cycles is marked as deprecated, no doubt because its use leads to poor quality code
because it blocks the processor but still runs at full power. In this class, you should
generally not write code which calls this function.</p>

<h4 id="part-2-understanding-what-the-c-compiler-is-doing">Part 2: Understanding what the C compiler is doing</h4>
<p>The goal of the compilation process is to turn a program written in a high level language into
machine code.</p>

<p><strong>Please read</strong> <a href="https://www.theunterminatedstring.com/the-greedy-c-runtime/">this very interesting
writeup</a> about what code is
generated by a C compiler when it is naively called and after code size optimization is done.
We will discuss the operations of the compiler/assembler in class.</p>

<p>For those of you interested in understanding how compiler-to-opcode conversion might have
interesting effects in the modern day context,
<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Domas-Breaking-The-x86-ISA.pdf">this</a> is an
interesting presentation from the 2017 BlackHat conference.</p>

<h4 id="part-3-blinking-a-morse-code-message">Part 3: Blinking a Morse Code Message</h4>

<p>Using the P1.0 LED on your launchpad, blink a message in morse code. Look morse code up on
wikipedia to find the code for each letter and how to separate letters. Submit your code in a
separate file named <code class="highlighter-rouge">morse-code.c</code>. <strong>Every line should have a meaningful comment and extra
comments are welcome!</strong> A few specifications:</p>

<ul>
  <li>A “unit” should be ¼ of a second.</li>
  <li>Use whatever clock and Timer mode you want.</li>
  <li>Organize your code such that to change the message, you only have to change one array at the
beginning of your program (this should be an array of Morse code “dots” and “dashes”).</li>
  <li>Be able to display either “SOS” or 3 other letters (i.e., your initials, the first 3 letters
of your first name, etc), depending on which array is commented out.</li>
  <li>Your message should repeat.</li>
  <li>Consider repetitions of your message different words. This means that you should have 7
“units” of off time between each repetition. If you want, this as well as spaces between
letters and parts of the same letter can be hard coded into your array.</li>
  <li>To help yourself write clean code, you should use “BITx” whenever you do anything with a pin
on the MSP430.</li>
  <li>You should use one of the timer interrupts for timing. Function LED flashing code is given in
an example from the MSP-example code archive in the “Labs/Lab1/” directory of the <a href="https://github.com/ckemere/ELEC327">course
repository</a>.</li>
  <li><strong>Continuing Bonus 1:</strong> For those of you feeling particularly under-tasked by this lab, extra
credit will be given for a second implementation of code that reads in the LED flashes and
decodes the Morse code message. See Bonus page for more details.</li>
</ul>

<h4 id="part-3-moving-it-to-a-breadboard">Part 3: Moving it to a Breadboard</h4>

<p>We’ll be working with a lot of input/output devices in this class, and so it makes sense to be
able to program an MSP430 on a breadboard so that it can run independently. Make this
breadboard wiring clean, as you’ll be testing a lot of circuits using it. To actually program
the MSP430 on a breadboard using the launchpad, you only need to:</p>

<ol>
  <li>Connect the TEST and RST pins on the EMULATION side of the launchpad to their respective
pins on the MSP430 (these are labeled on the launchpad where the MSP430 itself is usually
located).</li>
  <li>Connect Vcc and GND (or some independent battery, but for now use the launchpad’s power) to
their respective pins. For your convenience, jump these to the power lines on the
breadboard. To ensure a clean power supply to the MSP430, connect a 10uF capacitor anywhere on
the board between Vcc and GND.</li>
  <li>Connect a pull-up resistor to the RST pin, as it is active-low. That is, connect a large
resistor (47K from lab is fine) from the RST pin to Vcc, to ensure that its default state is
high.</li>
</ol>

<p>Now, reproduce your morse code circuit on the breadboard using LEDs and resistors in the lab.
There are, however, some differences you need to take into account – <strong>see questions below!</strong>
Wire the circuit on your breadboard, and successfully program it.</p>

<h4 id="demoing-code">Demoing code</h4>

<p>Over the course of the semester we will be developing a good schedule for demos. You will be
required to demonstrate your code to one of the course staff. You should be prepared to show
your code running on a breadboard, as well as changing the morse code message, reprogramming,
and showing the subsequent functioning.</p>

<h4 id="questions-10-pts-each">Questions (10 pts each):</h4>

<p>Please reference your answers to one of the authoritative sources.</p>

<p><em>Questions from week 1 of class:</em></p>

<ol class="questions" start="1">
<li><i>Reverse engineer code to answer questions.</i>
Each of you will have a sligthly different code binary. You should convert the machine code back
into assembly and understand how it works.  The code flashes one of the Launchpad LEDs. You
need to answer the following questions: (a) How does the code work? (b) What is the period at
which it happens?  (c) What register is used to keep track of timing? (d) Which LED flashes?
</li>
</ol>

<p>An example of what it will look like is here:</p>

<p><img src="intel-hex.png" alt="intel-hex" /></p>

<p>Download the <a href="BinaryFiles.zip">zip archive</a> which contains 143 directories. You will be given
access to a Google Sheets spreadsheet with your netid and the directory containing the code you
should view. Each directory contains two files. An ELF format file, <code class="highlighter-rouge">binary_file.o</code>, which can be
uploaded to the MSP430 and an Intel-Hex format file, <code class="highlighter-rouge">binary_file.hex</code> which contains the same
information in ASCII format. The <a href="https://en.wikipedia.org/wiki/Intel_HEX">Wikipedia page on Intel-Hex
format</a> describes how to interpret
this data. If you open it with “vim” or another code editor (e.g., atom, with the “intel-hex”
colors enabled), you will see the fields of the file properly colorized. <em>Hint 1:</em> Remember
that the MSP430 memory is little-endian. <em>Hint 2:</em> You’ll want to make heavy use of Table 3-12
(“Core Instruction Map”) in the User Guide!</p>

<p><em>Questions from the skeleton code:</em></p>

<ol class="questions" start="2">
<li>In the Part 1 skeleton code, what is the frequency and period of the LED?</li>
</ol>

<p><em>Questions from bread-boarding:</em></p>

<ol class="questions" start="3">
<li>What is the forward voltage on the LED? What is its maximum forward current?</li>
<li>What is the supply voltage coming out of the MSP430? On the MSP430G2553, what is the
maximum current any one pin can output?</li>
<li>Using all this, what is the resistor value you should use to supply exactly this maximum
current? To be safe when using the MSP430, should you use a larger or smaller resistor?</li>
</ol>

<p><strong>Upload your answers to the questions to the Google Form, and your code to Canvas. Make sure
to demo functionality by the deadline.</strong></p>



      <hr>
      <footer>
        <p>
        &copy; 2019 <a href="http://kemerelab.com">Caleb Kemere</a>
        and <a href="http://www.ece.rice.edu">Rice University ECE</a>
        </p>
      </footer>
    </div>

    

    <script src="/assets/themes/bootstrap/resources/jquery/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>


